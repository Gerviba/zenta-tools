.PRECIOUS: %.xml %.rich %.objlist %.richescape %.docbook %.html %.pdf %.pics %.tabled.docbook %.check %.consistencycheck

%.xml: %.yml
	$(ZENTATOOLS)/bin/yml2xml $< |saxon9 -xsl:$(ZENTATOOLS)/xslt/identity.xslt -s:- >$@
	
%.rich: %.zenta $(ZENTATOOLS)/xslt/enrich.xslt $(ZENTATOOLS)/classes
	saxon9 -xsl:$(ZENTATOOLS)/xslt/enrich.xslt -s:$< -im:enrich -o:$@

%.objlist: %.rich $(ZENTATOOLS)/xslt/objlist.xslt 
	saxon9 -xsl:$(ZENTATOOLS)/xslt/objlist.xslt -s:$< -o:$@

%.richescape: %.rich $(ZENTATOOLS)/xslt/unescape.xslt
	saxon9 -xsl:$(ZENTATOOLS)/xslt/unescape.xslt -s:$< -o:$@

%.docbook: %.richescape %.objlist $(ZENTATOOLS)/xslt/docbook.xslt %.consistencycheck $(ZENTATOOLS)/classes inputs/%.issues.xml
	saxon9 -xsl:$(ZENTATOOLS)/xslt/docbook.xslt -im:varlist -s:$< -o:$@ inconsistencyfile=$$(pwd)/$(basename $@).consistencycheck issuesfile=$$(pwd)/inputs/$(basename $@).issues.xml

%.tabled.docbook: %.richescape %.objlist $(ZENTATOOLS)/xslt/docbook.xslt
	saxon9 -xsl:$(ZENTATOOLS)/xslt/docbook.xslt -s:$< -o:$@

%.html: %.docbook $(ZENTATOOLS)/xslt/docbook2html.xslt
	saxon9 -xsl:$(ZENTATOOLS)/xslt/docbook2html.xslt -s:$< -o:$@

%.tabled.html: %.tabled..docbook $(ZENTATOOLS)/xslt/docbook2html.xslt
	saxon9 -xsl:$(ZENTATOOLS)/xslt/docbook2html.xslt -s:$< -o:$@

%.pdf: %.docbook %.pics $(ZENTATOOLS)/classes
	sed 's/fileref="pics/fileref="$(basename $@).pics/g' <$(basename $@).docbook >$(basename $@).docbook.repic
	dblatex $(basename $@).docbook.repic -o $@
	rm $(basename $@).docbook.repic

%.pics: %.zenta
	rm -rf $@ pics
	mkdir pics
	/opt/Zenta/Zenta -data ~/.zenta -load $$(pwd)/$< -targetdir $$(pwd) -runstyle $(ZENTATOOLS)/diagrams.style -exit
	mv pics $@

%.check:
	sed 's/MODELNAME/$(basename $@)/' <$(ZENTATOOLS)/example.check >$@

%.consistencycheck: %.rich %.check
	saxon9 -xsl:$(ZENTATOOLS)/xslt/consistencycheck.xslt -s:$(basename $@).check -o:$@ 2>&1 | sed 's/\//:/'  |sort --field-separator=':' --key=2

%.zip: %/index.html
	zip -ro $@ $$(basename $@ .zip)

%.compiled: %.html %.tabled.html %.pdf %.pics %.consistencycheck
	mkdir -p $(basename $@)
	cp $(ZENTATOOLS)/static/structured.css $(basename $@)
	cp $(basename $@).html $(basename $@)/index.html
	cp $(basename $@).tabled.html $(basename $@)/tabled.html
	cp $(basename $@).pdf $(basename $@)
	cp -r $(basename $@).pics $(basename $@)/pics
	touch $@


modelclean:
	rm -rf *.rich *.objlist *.richescape *.docbook *.html *.pdf *.pics *.zip *.compiled

$(ZENTATOOLS)/classes: $(ZENTATOOLS)/src/net/sf/saxon/trans/RelativeUriResolver.java
	mkdir -p $(ZENTATOOLS)/classes
	javac -cp /usr/local/lib/saxon9.jar -d $(ZENTATOOLS)/classes $(ZENTATOOLS)/src/net/sf/saxon/trans/RelativeUriResolver.java

