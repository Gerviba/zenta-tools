.PRECIOUS: %.xml %.rich %.objlist %.richescape %.docbook %.html %.pdf %.pics %.tabled.docbook

%.xml: %.yml
	$(ADADOCS)/bin/yml2xml $< |saxon9 -xsl:$(ADADOCS)/xslt/identity.xslt -s:- >$@
	
%.rich: %.zenta $(ADADOCS) $(ADADOCS)/xslt/enrich.xslt
	saxon9 -xsl:$(ADADOCS)/xslt/enrich.xslt -s:$< -im:enrich -o:$@

%.objlist: %.rich $(ADADOCS)/xslt/objlist.xslt
	saxon9 -xsl:$(ADADOCS)/xslt/objlist.xslt -s:$< -o:$@

%.richescape: %.rich $(ADADOCS)/xslt/unescape.xslt
	saxon9 -xsl:$(ADADOCS)/xslt/unescape.xslt -s:$< -o:$@

%.docbook: %.richescape %.objlist docbook.xslt $(ADADOCS)/xslt/docbook.xslt
	saxon9 -xsl:docbook.xslt -im:varlist -s:$< -o:$@

%.tabled.docbook: %.richescape %.objlist docbook.xslt $(ADADOCS)/xslt/docbook.xslt
	saxon9 -xsl:docbook.xslt -s:$< -o:$@

%.html: %.docbook $(ADADOCS)/xslt/docbook2html.xslt
	saxon9 -xsl:$(ADADOCS)/xslt/docbook2html.xslt -s:$< -o:$@

%.tabled.html: %.tabled..docbook $(ADADOCS)/xslt/docbook2html.xslt
	saxon9 -xsl:$(ADADOCS)/xslt/docbook2html.xslt -s:$< -o:$@

%.pdf: %.docbook %.pics
	sed 's/fileref="pics/fileref="$(basename $@).pics/g' <$(basename $@).docbook >$(basename $@).docbook.repic
	dblatex $(basename $@).docbook.repic -o $@
	rm $(basename $@).docbook.repic

%.pics: %.zenta
	rm -rf $@ pics
	mkdir pics
	/opt/Zenta/Zenta -data ~/.zenta -load $$(pwd)/$< -targetdir $$(pwd) -runstyle $(ADADOCS)/diagrams.style -exit
	mv pics $@

%.zip: %/index.html
	zip -ro $@ $$(basename $@ .zip)

%.compiled: %.html %.tabled.html %.pdf %.pics
	mkdir -p $(basename $@)
	cp $(ADADOCS)/static/structured.css $(basename $@)
	cp $(basename $@).html $(basename $@)/index.html
	cp $(basename $@).tabled.html $(basename $@)/tabled.html
	cp $(basename $@).pdf $(basename $@)
	cp -r $(basename $@).pics $(basename $@)/pics
	touch $@


modelclean:
	rm -rf *.rich *.objlist *.richescape *.docbook *.html *.pdf *.pics *.zip *.compiled

